<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Poe Chat App</title>
  <style>
    body{background:#0f1115;color:#e6edf3;font-family:sans-serif;margin:0;padding:0}
    .composer{position:fixed;bottom:0;width:100%;background:#141821;padding:12px;display:flex;gap:8px}
    .textarea{flex:1;min-height:44px;max-height:200px;overflow:auto;border:none;outline:none;background:#0f1115;color:#e6edf3;padding:8px;border-radius:6px}
    .btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
    .btn.primary{background:#4f8eff;color:#fff}
    .file-hidden{opacity:0;position:absolute;left:-9999px;width:0;height:0}
  </style>
</head>
<body>
  <div id="chat"></div>
  <div class="composer">
    <textarea id="text" class="textarea" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></textarea>
    <input id="file" type="file" accept="image/*" class="file-hidden">
    <button id="imgBtn" class="btn">ğŸ–¼ å›¾ç‰‡</button>
    <button id="send" class="btn primary">å‘é€</button>
  </div>

  <script>
    const API_BASE = '/api';
    const DEFAULT_MODEL = 'sml-fanhuati.XUANTI';

    async function toDataUrl(file){
      return new Promise((ok,no)=>{
        const r=new FileReader();
        r.onerror=no;
        r.onload=()=>ok(r.result);
        r.readAsDataURL(file);
      });
    }

    async function send(){
      const t = document.getElementById('text');
      const f = document.getElementById('file');
      const text = t.value.trim();
      const file = f.files[0];
      if (!text && !file){ t.focus(); return; }

      let userContent = text;
      if (file){
        const url = await toDataUrl(file);
        userContent = [
          { type:'text', text: text || 'çœ‹å›¾è¯´è¯' },
          { type:'image_url', image_url:{ url } }
        ];
      }

      try{
        const res = await fetch(API_BASE + '/ask', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            model: DEFAULT_MODEL,
            messages: [{ role:'user', content: userContent }]
          })
        });
        const data = await res.json();
        console.log('å“åº”:', data);
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML += '<div><b>æˆ‘:</b> '+(typeof userContent==='string'?userContent:'[å›¾æ–‡æ¶ˆæ¯]')+'</div>';
        chatDiv.innerHTML += '<div><b>åŠ©æ‰‹:</b> '+(data?.choices?.[0]?.message?.content || '(æ— å“åº”)')+'</div>';
        chatDiv.scrollTop = chatDiv.scrollHeight;
      } catch(err){
        console.error('è°ƒç”¨å¤±è´¥ï¼š', err);
      }

      t.value=''; f.value='';
    }

    document.getElementById('send').onclick = send;
    document.getElementById('imgBtn').onclick = ()=>{ document.getElementById('file').click(); };
    const ta = document.getElementById('text');
    ta.addEventListener('keydown', function(e){
      if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });
    window.send = send;
  </script>
</body>
</html>
